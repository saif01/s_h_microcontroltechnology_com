import{a as j}from"./adminPaginationMixin-DN7Wb3ng.js";import{r as G,n as H}from"./uploads-CnEkgyD_.js";import{_ as W,d as c,a,b as r,w as l,f as p,r as d,g as v,t as m,F as P,e as x,h as J,c as k,M as Y,N as K,x as S,o as u}from"./app-DXzZSook.js";const Q={mixins:[j],data(){return{users:[],roles:[],roleFilter:null,roleOptions:[],dialog:!1,editingUser:null,saving:!1,form:{name:"",email:"",role_ids:[],password:"",password_confirmation:"",avatar:""},rules:{required:s=>Array.isArray(s)?s.length>0||"At least one role is required":!!s||"This field is required",email:s=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s)||"Invalid email",minLength:s=>s?s.length>=8||"Password must be at least 8 characters":!0},currentUserId:null,showPassword:!1,showPasswordConfirmation:!1,avatarFile:null,uploadingAvatar:!1}},async mounted(){await this.loadRoles(),await this.loadUsers(),this.loadCurrentUser()},methods:{async loadUsers(){try{this.loading=!0;const s=this.buildPaginationParams();this.search&&(s.search=this.search),this.roleFilter&&(s.role=this.roleFilter);const e=await this.$axios.get("/api/v1/users",{params:s,headers:this.getAuthHeaders()}),h=e.data.data||[];this.users=h,this.updatePagination(e.data)}catch(s){this.handleApiError(s,"Failed to load users")}finally{this.loading=!1}},async loadRoles(){try{const s=await this.$axios.get("/api/v1/users/roles",{headers:this.getAuthHeaders()});this.roles=s.data.roles,this.roleOptions=this.roles.map(e=>({title:e.label,value:e.value}))}catch(s){console.error("Error loading roles:",s)}},loadCurrentUser(){const s=localStorage.getItem("admin_token");this.$axios.get("/api/v1/auth/user",{headers:{Authorization:`Bearer ${s}`}}).then(e=>{this.currentUserId=e.data.id}).catch(()=>{})},openDialog(s){if(this.avatarFile=null,s){this.editingUser=s;const e=s.roles?s.roles.map(f=>f.id):[],h=this.normalizeImageInput(s.avatar||"");this.form={name:s.name,email:s.email,role_ids:e,password:"",password_confirmation:"",avatar:h}}else{this.editingUser=null;const e=this.roles.length>0?this.roles[0].value:null;this.form={name:"",email:"",role_ids:e?[e]:[],password:"",password_confirmation:"",avatar:""}}this.dialog=!0},closeDialog(){this.dialog=!1,this.editingUser=null;const s=this.roles.length>0?this.roles[0].value:null;this.form={name:"",email:"",role_ids:s?[s]:[],password:"",password_confirmation:"",avatar:""},this.showPassword=!1,this.showPasswordConfirmation=!1,this.avatarFile=null,this.$refs.form&&this.$refs.form.resetValidation()},async handleAvatarUpload(){var h;if(!this.avatarFile)return;const s=Array.isArray(this.avatarFile)?this.avatarFile[0]:this.avatarFile;if(!s)return;if(!s.type.startsWith("image/")){this.showError("Please select a valid image file"),this.avatarFile=null;return}const e=5*1024*1024;if(s.size>e){this.showError("File size must be less than 5MB"),this.avatarFile=null;return}this.uploadingAvatar=!0;try{const f=new FormData;f.append("image",s),f.append("folder","users"),this.form.name&&f.append("prefix",this.form.name);const t=localStorage.getItem("admin_token"),i=await this.$axios.post("/api/v1/upload/image",f,{headers:{Authorization:`Bearer ${t}`,"Content-Type":"multipart/form-data"}});if(i.data.success){const n=this.normalizeImageInput(i.data.path||i.data.url);this.form.avatar=n,this.avatarFile=null,this.showSuccess("Avatar uploaded successfully")}else throw new Error(i.data.message||"Failed to upload avatar")}catch(f){console.error("Error uploading avatar:",f);let t="Failed to upload avatar";f.response?t=((h=f.response.data)==null?void 0:h.message)||f.response.statusText||t:f.message&&(t=f.message),this.showError(t),this.avatarFile=null}finally{this.uploadingAvatar=!1}},clearAvatar(){this.form.avatar="",this.avatarFile=null},async saveUser(){var s,e,h,f;if(this.form.password&&this.form.password!==this.form.password_confirmation){this.showError("Passwords do not match");return}if(!this.editingUser&&!this.form.password){this.showError("Password is required for new users");return}if(this.editingUser&&this.form.password&&!this.form.password_confirmation){this.showError("Please confirm the password");return}if(this.$refs.form.validate()){this.saving=!0;try{const t=localStorage.getItem("admin_token"),i=this.editingUser?`/api/v1/users/${this.editingUser.id}`:"/api/v1/users",n={...this.form};this.form.role_ids&&(n.role_ids=Array.isArray(this.form.role_ids)?this.form.role_ids:[this.form.role_ids]),this.form.password?n.password_confirmation=this.form.password_confirmation:(delete n.password,delete n.password_confirmation),n.avatar=this.normalizeImageInput(n.avatar),delete n.role;const w=this.editingUser?"put":"post";await axios[w](i,n,{headers:{Authorization:`Bearer ${t}`}}),this.showSuccess(this.editingUser?"User updated successfully":"User created successfully"),this.closeDialog(),await this.loadUsers()}catch(t){console.error("Error saving user:",t);let i="Error saving user";if((e=(s=t.response)==null?void 0:s.data)!=null&&e.errors){const n=t.response.data.errors,w=[];Object.keys(n).forEach(U=>{w.push(n[U][0])}),i=w.join(", ")}else(f=(h=t.response)==null?void 0:h.data)!=null&&f.message&&(i=t.response.data.message);this.showError(i)}finally{this.saving=!1}}},async deleteUser(s){if(s.id===this.currentUserId){this.showError("You cannot delete your own account");return}if(confirm(`Are you sure you want to delete ${s.name}?`))try{const e=localStorage.getItem("admin_token");await this.$axios.delete(`/api/v1/users/${s.id}`,{headers:{Authorization:`Bearer ${e}`}}),this.showSuccess("User deleted successfully"),await this.loadUsers()}catch(e){this.handleApiError(e,"Error deleting user")}},getRoleLabel(s){const e=this.roles.find(h=>h.slug===s);return e?e.label:s},getRoleColor(s){return{administrator:"error",editor:"primary","hr-user":"success",staff:"info"}[s]||"primary"},onPerPageChange(){this.resetPagination(),this.loadUsers()},onSort(s){this.handleSort(s),this.loadUsers()},normalizeImageInput(s){return H(s)},resolveImageUrl(s){return G(s)}}},X={class:"page-header"},Z={class:"text-caption text-grey"},$={key:0},ee={class:"d-flex align-center"},se={class:"d-flex align-center"},te={class:"d-flex align-center"},re={class:"d-flex align-center gap-2"},oe={class:"d-flex flex-wrap gap-1"},ae={class:"d-flex"},le={class:"d-flex align-center gap-2"},ie={key:1,class:"text-white"},ne={key:0,class:"d-flex flex-wrap gap-1"},de={key:1,class:"text-caption text-grey"},me={key:0},ue={class:"d-flex flex-column flex-md-row justify-space-between align-center align-md-start gap-3 mt-4"},pe={class:"text-caption text-grey"},fe={key:0},ce={key:0,class:"ml-2"},he={key:1},ge={key:0,class:"d-flex align-center gap-2"},ve={key:1,class:"text-grey text-caption align-self-center"},we={class:"mb-4"},_e={key:0,class:"mb-3 text-center"};function ye(s,e,h,f,t,i){const n=d("v-btn"),w=d("v-select"),U=d("v-col"),y=d("v-text-field"),E=d("v-row"),V=d("v-card-text"),C=d("v-card"),I=d("v-card-title"),b=d("v-icon"),_=d("v-skeleton-loader"),z=d("v-img"),F=d("v-avatar"),A=d("v-chip"),R=d("v-table"),q=d("v-pagination"),N=d("v-list-item"),M=d("v-progress-circular"),B=d("v-file-input"),D=d("v-form"),L=d("v-spacer"),O=d("v-card-actions"),T=d("v-dialog");return u(),c("div",null,[a("div",X,[e[20]||(e[20]=a("h1",{class:"text-h4 page-title"},"User Management",-1)),r(n,{color:"primary","prepend-icon":"mdi-plus",onClick:e[0]||(e[0]=o=>i.openDialog(null)),class:"add-button"},{default:l(()=>e[19]||(e[19]=[p(" Add New User ")])),_:1,__:[19]})]),r(C,{class:"mb-4"},{default:l(()=>[r(V,null,{default:l(()=>[r(E,null,{default:l(()=>[r(U,{cols:"12",md:"4"},{default:l(()=>[r(w,{modelValue:s.perPage,"onUpdate:modelValue":[e[1]||(e[1]=o=>s.perPage=o),i.onPerPageChange],items:s.perPageOptions,label:"Items per page","prepend-inner-icon":"mdi-format-list-numbered",variant:"outlined",density:"compact"},null,8,["modelValue","items","onUpdate:modelValue"])]),_:1}),r(U,{cols:"12",md:"4"},{default:l(()=>[r(w,{modelValue:t.roleFilter,"onUpdate:modelValue":[e[2]||(e[2]=o=>t.roleFilter=o),i.loadUsers],items:t.roleOptions,label:"Filter by Role",variant:"outlined",density:"compact",clearable:""},null,8,["modelValue","items","onUpdate:modelValue"])]),_:1}),r(U,{cols:"12",md:"4"},{default:l(()=>[r(y,{modelValue:s.search,"onUpdate:modelValue":e[3]||(e[3]=o=>s.search=o),label:"Search by name or email","prepend-inner-icon":"mdi-magnify",variant:"outlined",density:"compact",clearable:"",onInput:i.loadUsers},null,8,["modelValue","onInput"])]),_:1})]),_:1})]),_:1})]),_:1}),r(C,null,{default:l(()=>[r(I,{class:"d-flex justify-space-between align-center"},{default:l(()=>[e[22]||(e[22]=a("span",null,"Users",-1)),a("span",Z,[e[21]||(e[21]=p(" Total Records: ")),a("strong",null,m(s.pagination.total||0),1),t.users.length>0?(u(),c("span",$," | Showing "+m((s.currentPage-1)*s.perPage+1)+" to "+m(Math.min(s.currentPage*s.perPage,s.pagination.total))+" of "+m(s.pagination.total),1)):v("",!0)])]),_:1,__:[22]}),r(V,null,{default:l(()=>[r(R,null,{default:l(()=>[a("thead",null,[a("tr",null,[a("th",{class:"sortable",onClick:e[4]||(e[4]=o=>i.onSort("name"))},[a("div",ee,[e[23]||(e[23]=p(" Name ")),r(b,{icon:s.getSortIcon("name"),size:"small",class:"ml-1"},null,8,["icon"])])]),a("th",{class:"sortable",onClick:e[5]||(e[5]=o=>i.onSort("email"))},[a("div",se,[e[24]||(e[24]=p(" Email ")),r(b,{icon:s.getSortIcon("email"),size:"small",class:"ml-1"},null,8,["icon"])])]),e[26]||(e[26]=a("th",null,"Role",-1)),a("th",{class:"sortable",onClick:e[6]||(e[6]=o=>i.onSort("created_at"))},[a("div",te,[e[25]||(e[25]=p(" Created ")),r(b,{icon:s.getSortIcon("created_at"),size:"small",class:"ml-1"},null,8,["icon"])])]),e[27]||(e[27]=a("th",null,"Actions",-1))])]),a("tbody",null,[s.loading?(u(),c(P,{key:0},x(5,o=>a("tr",{key:`skeleton-${o}`},[a("td",null,[a("div",re,[r(_,{type:"avatar",width:"32",height:"32"}),r(_,{type:"text",width:"150"})])]),a("td",null,[r(_,{type:"text",width:"200"})]),a("td",null,[a("div",oe,[r(_,{type:"chip",width:"80",height:"24",class:"mr-1"}),r(_,{type:"chip",width:"70",height:"24"})])]),a("td",null,[r(_,{type:"text",width:"120"})]),a("td",null,[a("div",ae,[r(_,{type:"button",width:"32",height:"32",class:"mr-1"}),r(_,{type:"button",width:"32",height:"32"})])])])),64)):(u(),c(P,{key:1},[(u(!0),c(P,null,x(t.users,o=>(u(),c("tr",{key:o.id},[a("td",null,[a("div",le,[r(F,{size:"32",color:"primary"},{default:l(()=>[o.avatar?(u(),k(z,{key:0,src:o.avatar,alt:o.name},null,8,["src","alt"])):(u(),c("span",ie,m(o.name.charAt(0).toUpperCase()),1))]),_:2},1024),p(" "+m(o.name),1)])]),a("td",null,m(o.email),1),a("td",null,[o.roles&&o.roles.length>0?(u(),c("div",ne,[(u(!0),c(P,null,x(o.roles,g=>(u(),k(A,{key:g.id,color:i.getRoleColor(g.slug),size:"small"},{default:l(()=>[p(m(g.name),1)]),_:2},1032,["color"]))),128))])):(u(),c("span",de,"No roles"))]),a("td",null,m(s.formatDate(o.created_at)),1),a("td",null,[r(n,{size:"small",icon:"mdi-pencil",onClick:g=>i.openDialog(o),variant:"text"},null,8,["onClick"]),r(n,{size:"small",icon:"mdi-delete",onClick:g=>i.deleteUser(o),variant:"text",color:"error",disabled:o.id===t.currentUserId},null,8,["onClick","disabled"])])]))),128)),t.users.length===0?(u(),c("tr",me,e[28]||(e[28]=[a("td",{colspan:"5",class:"text-center py-4"},"No users found",-1)]))):v("",!0)],64))])]),_:1}),a("div",ue,[a("div",pe,[t.users.length>0&&s.pagination.total>0?(u(),c("span",fe,[e[29]||(e[29]=p(" Showing ")),a("strong",null,m((s.currentPage-1)*s.perPage+1),1),e[30]||(e[30]=p(" to ")),a("strong",null,m(Math.min(s.currentPage*s.perPage,s.pagination.total)),1),e[31]||(e[31]=p(" of ")),a("strong",null,m(s.pagination.total.toLocaleString()),1),e[32]||(e[32]=p(" records ")),s.pagination.last_page>1?(u(),c("span",ce," (Page "+m(s.currentPage)+" of "+m(s.pagination.last_page)+") ",1)):v("",!0)])):(u(),c("span",he," No records found "))]),s.pagination.last_page>1?(u(),c("div",ge,[r(q,{modelValue:s.currentPage,"onUpdate:modelValue":[e[7]||(e[7]=o=>s.currentPage=o),i.loadUsers],length:s.pagination.last_page,"total-visible":7,density:"comfortable"},null,8,["modelValue","length","onUpdate:modelValue"])])):v("",!0)])]),_:1})]),_:1}),r(T,{modelValue:t.dialog,"onUpdate:modelValue":e[18]||(e[18]=o=>t.dialog=o),"max-width":"600",persistent:""},{default:l(()=>[r(C,null,{default:l(()=>[r(I,null,{default:l(()=>[p(m(t.editingUser?"Edit User":"Add New User"),1)]),_:1}),r(V,null,{default:l(()=>[r(D,{ref:"form",onSubmit:J(i.saveUser,["prevent"])},{default:l(()=>[r(y,{modelValue:t.form.name,"onUpdate:modelValue":e[8]||(e[8]=o=>t.form.name=o),label:"Full Name",rules:[t.rules.required],required:"",class:"mb-4"},null,8,["modelValue","rules"]),r(y,{modelValue:t.form.email,"onUpdate:modelValue":e[9]||(e[9]=o=>t.form.email=o),label:"Email",type:"email",rules:[t.rules.required,t.rules.email],required:"",class:"mb-4"},null,8,["modelValue","rules"]),r(w,{modelValue:t.form.role_ids,"onUpdate:modelValue":e[10]||(e[10]=o=>t.form.role_ids=o),items:t.roles,"item-title":"label","item-value":"value",label:"Roles",rules:[t.rules.required],required:"",multiple:"",chips:"",class:"mb-4"},{item:l(({props:o,item:g})=>[r(N,Y(K(o)),{title:l(()=>[p(m(g.raw.label)+" ",1),g.raw.is_system?(u(),k(A,{key:0,size:"x-small",color:"warning",class:"ml-2"},{default:l(()=>e[33]||(e[33]=[p(" System ")])),_:1,__:[33]})):v("",!0)]),subtitle:l(()=>[p(m(g.raw.description),1)]),_:2},1040)]),selection:l(({item:o,index:g})=>[g<2?(u(),k(A,{key:0,size:"small",class:"mr-1"},{default:l(()=>[p(m(o.raw.label),1)]),_:2},1024)):v("",!0),g===2?(u(),c("span",ve," (+"+m(t.form.role_ids.length-2)+" others) ",1)):v("",!0)]),_:1},8,["modelValue","items","rules"]),r(y,{modelValue:t.form.password,"onUpdate:modelValue":e[12]||(e[12]=o=>t.form.password=o),label:"Password",type:t.showPassword?"text":"password",rules:t.editingUser?[]:[t.rules.required,t.rules.minLength],required:!t.editingUser,hint:"Leave blank to keep current password","persistent-hint":"",class:"mb-4"},{"append-inner":l(()=>[r(n,{icon:"",variant:"text",size:"small",onClick:e[11]||(e[11]=o=>t.showPassword=!t.showPassword)},{default:l(()=>[r(b,null,{default:l(()=>[p(m(t.showPassword?"mdi-eye-off":"mdi-eye"),1)]),_:1})]),_:1})]),_:1},8,["modelValue","type","rules","required"]),!t.editingUser||t.form.password?(u(),k(y,{key:0,modelValue:t.form.password_confirmation,"onUpdate:modelValue":e[14]||(e[14]=o=>t.form.password_confirmation=o),label:"Confirm Password",type:t.showPasswordConfirmation?"text":"password",rules:t.form.password?[()=>!!t.form.password_confirmation||"Please confirm your password",()=>t.form.password_confirmation===t.form.password||"Passwords do not match"]:[],required:!!t.form.password,class:"mb-4"},{"append-inner":l(()=>[r(n,{icon:"",variant:"text",size:"small",onClick:e[13]||(e[13]=o=>t.showPasswordConfirmation=!t.showPasswordConfirmation)},{default:l(()=>[r(b,null,{default:l(()=>[p(m(t.showPasswordConfirmation?"mdi-eye-off":"mdi-eye"),1)]),_:1})]),_:1})]),_:1},8,["modelValue","type","rules","required"])):v("",!0),a("div",we,[e[35]||(e[35]=a("div",{class:"text-subtitle-2 font-weight-medium mb-2"},"Avatar",-1)),t.form.avatar?(u(),c("div",_e,[r(F,{size:"80",class:"mb-2"},{default:l(()=>[r(z,{src:t.form.avatar?i.resolveImageUrl(t.form.avatar):"",alt:"Avatar Preview"},null,8,["src"])]),_:1}),a("div",null,[r(n,{size:"small",variant:"text",color:"error","prepend-icon":"mdi-delete",onClick:i.clearAvatar},{default:l(()=>e[34]||(e[34]=[p("Remove Avatar")])),_:1,__:[34]},8,["onClick"])])])):v("",!0),r(B,{modelValue:t.avatarFile,"onUpdate:modelValue":[e[15]||(e[15]=o=>t.avatarFile=o),i.handleAvatarUpload],label:"Upload Avatar",variant:"outlined",density:"comfortable",color:"primary",accept:"image/*","prepend-icon":"mdi-image",hint:"Upload an avatar image (JPG, PNG, GIF, WebP - Max 5MB). Recommended size: 200x200px","persistent-hint":"","show-size":"",class:"mb-3"},S({_:2},[t.uploadingAvatar?{name:"append-inner",fn:l(()=>[r(M,{indeterminate:"",size:"20",color:"primary"})]),key:"0"}:void 0]),1032,["modelValue","onUpdate:modelValue"]),r(y,{modelValue:t.form.avatar,"onUpdate:modelValue":e[17]||(e[17]=o=>t.form.avatar=o),label:"Or Enter Avatar URL",variant:"outlined",density:"comfortable",color:"primary",hint:"Enter a direct URL to the avatar image","persistent-hint":"","prepend-inner-icon":"mdi-link"},S({_:2},[t.form.avatar&&!t.avatarFile?{name:"append-inner",fn:l(()=>[r(n,{icon:"mdi-open-in-new",variant:"text",size:"small",onClick:e[16]||(e[16]=o=>s.window.open(i.resolveImageUrl(t.form.avatar),"_blank"))})]),key:"0"}:void 0]),1032,["modelValue"])])]),_:1},8,["onSubmit"])]),_:1}),r(O,null,{default:l(()=>[r(L),r(n,{onClick:i.closeDialog,variant:"text"},{default:l(()=>e[36]||(e[36]=[p("Cancel")])),_:1,__:[36]},8,["onClick"]),r(n,{onClick:i.saveUser,color:"primary",loading:t.saving},{default:l(()=>[p(m(t.editingUser?"Update":"Create"),1)]),_:1},8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}const Pe=W(Q,[["render",ye],["__scopeId","data-v-a53b3008"]]);export{Pe as default};
